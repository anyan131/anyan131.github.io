<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>录制amr音频文件，拆分与重组后播放 | 闫昊良的技术博客</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">闫昊良</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">闫昊良</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">录制amr音频文件，拆分与重组后播放</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">闫昊良</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">June 17, 2021&nbsp;&nbsp;11:26:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="录制amr音频文件，拆分与重组后播放"><a href="#录制amr音频文件，拆分与重组后播放" class="headerlink" title="录制amr音频文件，拆分与重组后播放"></a>录制amr音频文件，拆分与重组后播放</h2><hr>
<p><strong>业务逻辑:</strong>  </p>
<ul>
<li>安卓录制amr音频文件，将文件以字节流的形式每1024发送一次、接收后重新组成文件、并且播放。</li>
</ul>
<p><strong>用到技术:</strong>  </p>
<ul>
<li>MQTT</li>
<li>MediaRecorder</li>
<li>AudioTrack</li>
<li>IO流</li>
<li>io.kvh:amr:1.1.1 （amr解码库）</li>
</ul>
<p><strong>先说录制：</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startRecorder</span><span class="params">()</span></span>&#123;</span><br><span class="line">            File soundFile = <span class="keyword">new</span> File(dir, System.currentTimeMillis() + <span class="string">"amr"</span>);</span><br><span class="line">            <span class="comment">//首先设置好临时文件soundFile的路径</span></span><br><span class="line">            Log.e(<span class="string">"bbb"</span>, soundFile.getAbsolutePath());</span><br><span class="line">            <span class="keyword">if</span> (!soundFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    soundFile.createNewFile();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MediaRecorder mr = <span class="keyword">new</span> MediaRecorder();</span><br><span class="line">            mr.setAudioSource(MediaRecorder.AudioSource.MIC);  <span class="comment">//音频输入源</span></span><br><span class="line">            mr.setOutputFormat(MediaRecorder.OutputFormat.AMR_NB);   <span class="comment">//设置输出格式</span></span><br><span class="line"><span class="comment">//            mr.setAudioSamplingRate(8000);</span></span><br><span class="line">            <span class="comment">//设置声音数据编码格式,音频通用格式是AMR</span></span><br><span class="line">            mr.setAudioEncod(MediaRecorderAudioEncoder.AMR_NB);</span><br><span class="line">            <span class="comment">//设置编码频率</span></span><br><span class="line"><span class="comment">//            mr.setAudioEncodingBitRate(16);</span></span><br><span class="line">            mr.setOutputFile(soundFile.getAbsolutePath());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mr.prepare();</span><br><span class="line">                mr.start();  <span class="comment">//开始录制</span></span><br><span class="line">                startTime = System.currentTimeMillis();</span><br><span class="line">                timer = <span class="keyword">new</span> Timer();</span><br><span class="line">                timer.schedule(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        count++;</span><br><span class="line">                        <span class="keyword">if</span> (count == <span class="number">30</span>) &#123;</span><br><span class="line">                            <span class="comment">//使用timer倒计时30秒自动结束并发送</span></span><br><span class="line">                            timer.cancel();</span><br><span class="line">                            count = <span class="number">0</span>;</span><br><span class="line">                            stopAndSend();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">0</span>, <span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>录制完成后：</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//停止并发送</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopAndSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    stopRecord();</span><br><span class="line">    Log.e(<span class="string">"MainActivity"</span>, <span class="string">"onKeyDown: 结束录音"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> groupId = SPUtils.getInstance().getIntegers(Constant.GROUPID, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个是我自定义的topic、用于收发mqtt消息的</span></span><br><span class="line">    CommunicationProtocol.getFileInputStream(soundFile, <span class="string">"ame/info/br_vm/"</span> + groupId,<span class="string">"\""</span> + tenantId + <span class="string">"\""</span>, <span class="string">"\""</span> + $assetId + <span class="string">"\""</span>, (<span class="keyword">byte</span>) <span class="number">0x00</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//停止录制，资源释放</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopRecord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mr.stop();</span><br><span class="line">        mr.release();</span><br><span class="line">        mr = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (timer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            timer.cancel();</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">            Log.e(TAG, <span class="string">"stopRecord: 停止计时"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>发送音频文件：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file      语音文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tenant_id 租户id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> assets_id 设备id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file_flag 文件标志</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getFileInputStream</span><span class="params">(File file, String topic, String tenant_id, String assets_id, <span class="keyword">byte</span> file_flag)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] bys = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];   <span class="comment">//一次读取1024字节、并发送</span></span><br><span class="line">    <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;   <span class="comment">//发送次数</span></span><br><span class="line">    <span class="keyword">int</span> send_sum;    <span class="comment">//总共需要发送的次数</span></span><br><span class="line">    <span class="keyword">int</span> readCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] newbyte;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> l = file.length() / <span class="number">1024.00</span>;  <span class="comment">//获取文件总长、并计算需要传输几次可传输完成</span></span><br><span class="line">    <span class="keyword">double</span> eps = <span class="number">1e-10</span>;</span><br><span class="line">    <span class="keyword">boolean</span> noHasDecimals = l - Math.floor(l) &lt; eps;</span><br><span class="line">    <span class="comment">//当返回为true时，说明数字的小数点后都是为0的；当为false时，说明数字的小数点后是有大于0的数字</span></span><br><span class="line">    <span class="keyword">if</span> (noHasDecimals) &#123;</span><br><span class="line">        send_sum = (<span class="keyword">int</span>) l;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        send_sum = (<span class="keyword">int</span>) l + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Log.d(TAG, <span class="string">"getFileInputStream:文件总大小 "</span> + file.length() + <span class="string">"  文件需要发送次数： "</span> + send_sum);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(bys)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//发送一次 次数++</span></span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">int</span> finalCount = count;</span><br><span class="line">            <span class="keyword">if</span> (len &lt; bys.length) &#123;</span><br><span class="line"></span><br><span class="line">                newbyte = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; newbyte.length; i++) &#123;</span><br><span class="line">                    newbyte[i] = bys[i];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//合并byte数组</span></span><br><span class="line">                Log.e(TAG, <span class="string">"getFileInputStream: 不足1024"</span> + len);</span><br><span class="line">                <span class="keyword">byte</span>[] sendBytes = sendVoiceMessage(tenant_id, assets_id, newbyte, file_flag, count, send_sum);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//mqtt推送数据</span></span><br><span class="line">                MqttManager.getInstance().publish(topic, MqttQos.AT_MOST_ONCE, sendBytes, Constant.CONTENT_TEXT, <span class="keyword">new</span> MqttActionCallBack() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Mqtt5PublishResult mqtt5PublishResult)</span> </span>&#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"onSuccess: 发送成功"</span> + finalCount);</span><br><span class="line">                        <span class="keyword">double</span> i = finalCount * <span class="number">1024.00</span>;</span><br><span class="line">                        Log.d(TAG, <span class="string">"onSuccess: 当前发送字节长度 "</span> + i);</span><br><span class="line">                        <span class="keyword">if</span> (finalCount == send_sum) &#123;</span><br><span class="line">                            <span class="comment">//最后一次次数 == 发送总和代表发送成功，删除文件</span></span><br><span class="line">                            file.delete();</span><br><span class="line">                            Log.d(TAG, <span class="string">"onSuccess: 发送成功、删除文件"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Mqtt5PublishResult asyncActionToken, Throwable exception)</span> </span>&#123;</span><br><span class="line">                        Log.e(TAG, <span class="string">"onFailure: 发送失败"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//合并byte数组</span></span><br><span class="line">                Log.e(TAG, <span class="string">"getFileInputStream: "</span> + len);</span><br><span class="line">                <span class="keyword">byte</span>[] sendBytes = sendVoiceMessage(tenant_id, assets_id, bys, file_flag, count, send_sum);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//mqtt推送数据</span></span><br><span class="line">                MqttManager.getInstance().publish(topic, MqttQos.AT_MOST_ONCE, sendBytes, Constant.CONTENT_TEXT, <span class="keyword">new</span> MqttActionCallBack() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Mqtt5PublishResult mqtt5PublishResult)</span> </span>&#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"onSuccess: 发送成功"</span> + finalCount);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Mqtt5PublishResult asyncActionToken, Throwable exception)</span> </span>&#123;</span><br><span class="line">                        Log.e(TAG, <span class="string">"onFailure: 发送失败"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭流</span></span><br><span class="line">        fis.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tenant_id 租户id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> assets_id 设备id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> buf       数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file_flag 文件标志</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> count     传输次数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] sendVoiceMessage(String tenant_id, String assets_id, <span class="keyword">byte</span>[] buf, <span class="keyword">byte</span> file_flag, <span class="keyword">int</span> count, <span class="keyword">int</span> last_num) &#123;</span><br><span class="line">    <span class="keyword">if</span> (count == last_num) &#123;  <span class="comment">//判断已经发送次数与需要发送的次数是否相等</span></span><br><span class="line">        <span class="keyword">return</span> byteMergerAll(tenant_id.getBytes(), assets_id.getBytes(), <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;file_flag&#125;, <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;(<span class="keyword">byte</span>) count&#125;, <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;(<span class="keyword">byte</span>) <span class="number">0x01</span>&#125;, buf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> byteMergerAll(tenant_id.getBytes(), assets_id.getBytes(), <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;file_flag&#125;, <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;(<span class="keyword">byte</span>) count&#125;, <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;(<span class="keyword">byte</span>) <span class="number">0x00</span>&#125;, buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 合并数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> values byte[]...数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 按照顺序合并后的数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] byteMergerAll(<span class="keyword">byte</span>[]... values) &#123;</span><br><span class="line">    <span class="keyword">int</span> length_byte = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">        length_byte += values[i].length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] all_byte = <span class="keyword">new</span> <span class="keyword">byte</span>[length_byte];</span><br><span class="line">    <span class="keyword">int</span> countLength = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] b = values[i];</span><br><span class="line">        System.arraycopy(b, <span class="number">0</span>, all_byte, countLength, b.length);</span><br><span class="line">        countLength += b.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> all_byte;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接收并且播放</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(<span class="keyword">int</span> group_id, Activity context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//接收方订阅与发送方一样的topic</span></span><br><span class="line">    MqttManager.getInstance().subscribeVoice(<span class="string">"ame/info/br_vm/"</span> + group_id, MqttQos.AT_MOST_ONCE, <span class="keyword">new</span> MqttMessageCallBack() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageArrived</span><span class="params">(Mqtt5Publish publish, <span class="keyword">byte</span>[] message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.messageArrived(publish, message);</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; message.length; i++) &#123;</span><br><span class="line">                <span class="comment">// 0x00 文件标志</span></span><br><span class="line">                <span class="keyword">if</span> (message[i] == (<span class="keyword">byte</span>) <span class="number">0x00</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.d(TAG, <span class="string">"messageArrived: "</span> + i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] front = Arrays.copyOfRange(message, <span class="number">0</span>, i);</span><br><span class="line"></span><br><span class="line">            String[] splitFront = <span class="keyword">new</span> String(front, <span class="string">"Utf-8"</span>).split(<span class="string">"\""</span>);</span><br><span class="line">            String assest = splitFront[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">            Log.e(TAG, <span class="string">"messageArrived: "</span> + assest + <span class="string">" 发来的消息"</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] behind = Arrays.copyOfRange(message, i + <span class="number">2</span>, message.length - <span class="number">1</span>);</span><br><span class="line">            String $assetId = <span class="keyword">new</span> String(behind, <span class="string">"UTF-8"</span>);</span><br><span class="line">            Log.e(TAG, <span class="string">"messageArrived: "</span> + behind.length);</span><br><span class="line"></span><br><span class="line">            Log.e(TAG, <span class="string">"messageArrived: 发送次数"</span> + message[i + <span class="number">1</span>]);</span><br><span class="line">            Log.e(TAG, <span class="string">"messageArrived: "</span> + (Integer.parseInt(String.valueOf(message[i + <span class="number">1</span>])) - <span class="number">1</span>));</span><br><span class="line">            byteArrays.add(Integer.parseInt(String.valueOf(message[i + <span class="number">1</span>])) - <span class="number">1</span>, behind);</span><br><span class="line">            <span class="comment">//byteArrays是一个byte[]类型的ArrayList</span></span><br><span class="line">            userMessageHashMap.put(assest, byteArrays);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (behind.length &lt; <span class="number">1024</span>) &#123;</span><br><span class="line">                <span class="comment">//收到的语音数据包不足1024</span></span><br><span class="line">                CommunicationProtocol.mergeByteArrays(context, byteArrays);</span><br><span class="line">                Log.e(TAG, <span class="string">"messageArrived: 合并文件 长度一共"</span> + byteArrays.size());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//合并接收到的字节流并播放</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mergeByteArrays</span><span class="params">(Activity context, ArrayList&lt;<span class="keyword">byte</span>[]&gt; bytes)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.run();</span><br><span class="line">                File file;</span><br><span class="line">                ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">byte</span>[] byteArray : bytes) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        byteArrayOutputStream.write(byteArray);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                FileOutputStream fileOutputStream = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> sdMounted = SaveFileUtils.isSDMounted(context);</span><br><span class="line">                <span class="keyword">if</span> (sdMounted) &#123;</span><br><span class="line">                    <span class="comment">//这步是为了我的设备能更好的选择存储空间，大家可以给一个临时地址</span></span><br><span class="line">                    <span class="comment">//这一步可以省略，主要就是为了有file能接收字节流</span></span><br><span class="line">                    file = SaveFileUtils.createSdcardFile(context, Constant.RECEIVE_VOICE);</span><br><span class="line">                    Log.e(TAG, <span class="string">"startRecord: 外置SD卡存在"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"startRecord: 外置SD卡不存在"</span>);</span><br><span class="line">                    File dir = <span class="keyword">new</span> File(Environment.getExternalStorageDirectory(), <span class="string">"recevie_voice"</span>);</span><br><span class="line">                    Log.e(<span class="string">"aaa"</span>, dir.getAbsolutePath());</span><br><span class="line">                    <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">                        dir.mkdirs();</span><br><span class="line">                    &#125;</span><br><span class="line">                    file = <span class="keyword">new</span> File(dir, System.currentTimeMillis() + <span class="string">".amr"</span>);</span><br><span class="line">                    Log.e(<span class="string">"bbb"</span>, file.getAbsolutePath());</span><br><span class="line">                    <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            file.createNewFile();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fileOutputStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">                    fileOutputStream.write(bytes);</span><br><span class="line">                    fileOutputStream.flush();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fileOutputStream.close();</span><br><span class="line">                        byteArrays.clear();</span><br><span class="line">                        <span class="comment">//关闭流之后再去播放</span></span><br><span class="line">                        AmrFileDecoder amrFileDecoder = <span class="keyword">new</span> AmrFileDecoder();</span><br><span class="line">                        amrFileDecoder.start(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>AmrFileDecoder类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AmrFileDecoder</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Thread mDecodeThread;</span><br><span class="line">    <span class="keyword">private</span> AudioTrack mAudioTrack;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InputStream mInputStream;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mDecoderState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] readBuffer;</span><br><span class="line">    <span class="keyword">byte</span>[] readBufferWithoutCompress;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> playerBufferSize = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 8 k * 16bit * 1 = 8k shorts</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SAMPLE_RATE = <span class="number">8000</span>;</span><br><span class="line">    <span class="comment">// 20 ms second</span></span><br><span class="line">    <span class="comment">// 0.02 x 8000 x 2 = 320;160 short</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PCM_FRAME_SIZE = <span class="number">160</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//using AmrEncoder.Mode.MR122 to encode, generated frame size would be 32</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AMR_FRAME_SIZE = <span class="number">32</span>;<span class="comment">// see io.kvh.media.sound.Codec</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> isRunning;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isRunning) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        isRunning = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        mDecoderState = AmrDecoder.init();</span><br><span class="line"></span><br><span class="line">        playerBufferSize = AudioTrack.getMinBufferSize(SAMPLE_RATE,</span><br><span class="line">                AudioFormat.CHANNEL_OUT_MONO, AudioFormat.ENCODING_PCM_16BIT);</span><br><span class="line">        mAudioTrack = <span class="keyword">new</span> AudioTrack(AudioManager.STREAM_MUSIC, SAMPLE_RATE,</span><br><span class="line">                AudioFormat.CHANNEL_OUT_MONO, AudioFormat.ENCODING_PCM_16BIT,</span><br><span class="line">                playerBufferSize, AudioTrack.MODE_STREAM);</span><br><span class="line">        readBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[AMR_FRAME_SIZE];</span><br><span class="line">        readBufferWithoutCompress = <span class="keyword">new</span> <span class="keyword">byte</span>[PCM_FRAME_SIZE];</span><br><span class="line"></span><br><span class="line">        mInputStream = inputStream;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//amr file has 6 bytes header: "23 21 41 4D 52 0A" =&gt; "#!amr.", so skip here</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInputStream.skip(<span class="number">7</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        mAudioTrack.play();</span><br><span class="line">        mDecodeThread = <span class="keyword">new</span> Thread(<span class="keyword">this</span>);</span><br><span class="line">        mDecodeThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isRunning)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        mDecodeThread.interrupt();</span><br><span class="line"></span><br><span class="line">        AmrDecoder.exit(mDecoderState);</span><br><span class="line"></span><br><span class="line">        isRunning = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        mAudioTrack.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (isRunning &amp;&amp; mInputStream.read(readBuffer) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// amr frame 32 bytes</span></span><br><span class="line">                <span class="keyword">byte</span>[] amrFrame = readBuffer.clone();</span><br><span class="line">                <span class="comment">// pcm frame 160 shorts</span></span><br><span class="line">                <span class="keyword">short</span>[] pcmFrame = <span class="keyword">new</span> <span class="keyword">short</span>[PCM_FRAME_SIZE];</span><br><span class="line">                AmrDecoder.decode(mDecoderState, amrFrame, pcmFrame);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 播放</span></span><br><span class="line">                mAudioTrack.write(pcmFrame, <span class="number">0</span>, pcmFrame.length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>以上就是我业务的全过程</strong></p>
<ul>
<li>Q1：使用AmrFileDecoder类解码时，amr文件字节头是6位、我为什么要skip(7)？</li>
<li>A1：我在合并期间可能出现了问题，一直无法播放，直到我对比了原文件与合成后的新文件，才发现问题所在。如图：<img src="http://www.yanhaoliang.xyz/NotePad++/2021-06-17_oldfile.png">
<img src="http://www.yanhaol.xyz/NotePad++/2021-06-17_newfile.png">
通过notepad++对比两个文件之后发现合并后的文件头多出了一个字节NULL，所以skip(7)</li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>闫昊良</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://yoursite.com/2021/06/17/录制amr音频文件、按1024字节拆分发送重组后播放/">http://yoursite.com/2021/06/17/录制amr音频文件、按1024字节拆分发送重组后播放/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY<strong>?</strong></strong></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2020/08/18/安卓CPU架构详解/">Android CPU 架构详解</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© 闫昊良 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
